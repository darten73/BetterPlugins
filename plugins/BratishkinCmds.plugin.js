//META{"name":"BratishkinCmds"}*//

class BratishkinCmds {
	initConstructor () {
		this.serverId='259124796971941890';
		this.channelGeneralId='259124796971941890';

		this.userTribunalSettingsMarkup =
            `<span class="cooladmin-modal DevilBro-modal">
			<div class="${BDFDBED.disCN.backdrop}"></div>
			<div class="${BDFDBED.disCN.modal}">
				<div class="${BDFDBED.disCN.modalinner}">
					<div class=${BDFDBED.disCNS.modalsub + BDFDBED.disCN.modalsizemedium}">
						<div class="${BDFDBED.disCNS.flex + BDFDBED.disCNS.flex2 + BDFDBED.disCNS.horizontal + BDFDBED.disCNS.horizontal2 + BDFDBED.disCNS.directionrow + BDFDBED.disCNS.justifystart + BDFDBED.disCNS.aligncenter + BDFDBED.disCNS.nowrap + BDFDBED.disCN.modalheader}" style="flex: 0 0 auto;">
							<div class="flexChild-1KGW5q" style="flex: 1 1 auto;">
								<h4 class="${BDFDBED.disCNS.h4 + BDFDBED.disCNS.headertitle + BDFDBED.disCNS.size16 + BDFDBED.disCNS.height20 + BDFDBED.disCNS.weightsemibold + BDFDBED.disCNS.defaultcolor + BDFDBED.disCNS.h4defaultmargin + BDFDBED.disCN.marginreset}">REPLACE_modal_title</h4>
								<div class="${BDFDBED.disCNS.modalguildname + BDFDBED.disCNS.small + BDFDBED.disCNS.size12 + BDFDBED.disCNS.height16 + BDFDBED.disCN.primary}"></div>
							</div>
							<svg class="${BDFDBED.disCNS.modalclose + BDFDBED.disCN.flexchild}" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 12 12">
								<g fill="none" fill-rule="evenodd">
									<path d="M0 0h12v12H0"></path>
									<path class="fill" fill="currentColor" d="M9.5 3.205L8.795 2.5 6 5.295 3.205 2.5l-.705.705L5.295 6 2.5 8.795l.705.705L6 6.705 8.795 9.5l.705-.705L6.705 6"></path>
								</g>
							</svg>
						</div>
						<div class="${BDFDBED.disCNS.flex + BDFDBED.disCNS.flex2 + BDFDBED.disCNS.vertical + BDFDBED.disCNS.directioncolumn + BDFDBED.disCNS.justifystart + BDFDBED.disCNS.alignstretch + BDFDBED.disCNS.nowrap + BDFDBED.disCN.marginbottom20}" style="flex: 0 0 auto;">
							<div class="${BDFDBED.disCNS.flex + BDFDBED.disCNS.flex2 + BDFDBED.disCNS.horizontal + BDFDBED.disCNS.horizontal2 + BDFDBED.disCNS.directionrow + BDFDBED.disCNS.justifystart + BDFDBED.disCNS.aligncenter + BDFDBED.disCNS.nowrap + BDFDBED.disCN.marginbottom8}" style="flex: 1 1 auto;">
								<h3 class="${BDFDBED.disCNS.titledefault + BDFDBED.disCNS.title + BDFDBED.disCNS.marginreset + BDFDBED.disCNS.weightmedium + BDFDBED.disCNS.size16 + BDFDBED.disCNS.height24 + BDFDBED.disCN.flexchild}" style="flex: 0 0 auto; margin: 0px 10px;">REPLACE_modal_reason_title</h3>
							</div>
							<div class="${BDFDBED.disCNS.flex + BDFDBED.disCNS.flex2 + BDFDBED.disCNS.horizontal + BDFDBED.disCNS.horizontal2 + BDFDBED.disCNS.directionrow + BDFDBED.disCNS.justifystart + BDFDBED.disCNS.aligncenter + BDFDBED.disCNS.nowrap + BDFDBED.disCNS.marginbottom8 + BDFDBED.disCN.modalsubinner}" style="flex: 1 1 auto;">
								<div class="${BDFDBED.disCNS.inputwrapper + BDFDBED.disCNS.vertical + BDFDBED.disCNS.flex + BDFDBED.disCNS.directioncolumn + BDFDBED.disCN.flexchild}" style="flex: 1 1 auto;"><input type="text" class="${BDFDBED.disCNS.inputdefault + BDFDBED.disCNS.input + BDFDBED.disCN.size16}" id="input-reason"></div>
							</div>

							<div class="${BDFDBED.disCNS.flex + BDFDBED.disCNS.flex2 + BDFDBED.disCNS.horizontal + BDFDBED.disCNS.horizontal2 + BDFDBED.disCNS.directionrow + BDFDBED.disCNS.justifystart + BDFDBED.disCNS.aligncenter + BDFDBED.disCNS.nowrap + BDFDBED.disCNS.marginbottom8 + BDFDBED.disCN.modalsubinner}" style="flex: 1 1 auto;">
								<h3 id="warning" class="${BDFDBED.disCNS.flex + BDFDBED.disCNS.flex2 + BDFDBED.disCNS.horizontal + BDFDBED.disCNS.horizontal2 + BDFDBED.disCNS.directionrow + BDFDBED.disCNS.justifystart + BDFDBED.disCNS.aligncenter + BDFDBED.disCNS.nowrap + BDFDBED.disCN.marginbottom8}" style="flex: 0 0 auto; color: rgb(240, 71, 71)">REPLACE_modal_warning</h3>
							</div>
						</div>
						<div class="${BDFDBED.disCNS.flex + BDFDBED.disCNS.flex2 + BDFDBED.disCNS.horizontalreverse + BDFDBED.disCNS.horizontalreverse2 + BDFDBED.disCNS.directionrowreverse + BDFDBED.disCNS.justifystart + BDFDBED.disCNS.alignstretch + BDFDBED.disCNS.nowrap + BDFDBED.disCN.modalfooter}">
								<button type="button" class="btn-save ${BDFDBED.disCNS.button + BDFDBED.disCNS.buttonlookfilled + BDFDBED.disCNS.buttoncolorbrand + BDFDBED.disCNS.buttonsizemedium + BDFDBED.disCN.buttongrow}">
									<div>REPLACE_modal_button_name</div>
								</button>
							</div>
					</div>
				</div>
			</span>`;
	}
	
	getName () {return "BratishkinCmds";}

	getDescription () {return "Меню автозаполнения для сервера Баштеркина";}

	getVersion () {return "1.0.0";}

	getAuthor () {return "Dario";}


	//legacy
	load () {}

	start () {
		var libraryScript = null;
		if (typeof BDFDBED !== "object" || BDFDBED.isLibraryOutdated()) {
            if (typeof BDFDBED === "object") BDFDBED = "";
            libraryScript = document.querySelector('head script[src="https://darten73.github.io/BetterPlugins/BDFDBED.js"]');
            if (libraryScript) libraryScript.remove();
            libraryScript = document.createElement("script");
            libraryScript.setAttribute("type", "text/javascript");
            libraryScript.setAttribute("src", "https://darten73.github.io/BetterPlugins/BDFDBED.js");
            document.head.appendChild(libraryScript);
        }
		this.startTimeout = setTimeout(() => {this.initialize();}, 30000);
		if (typeof BDFDBED === "object" && typeof BDFDBED.isLibraryOutdated === "function") this.initialize();
		else libraryScript.addEventListener("load", () => {this.initialize();});
	}

	initialize () {
		if (typeof BDFDBED === "object") {
			BDFDBED.loadMessage(this);

			this.UploadModule = BDFDBED.WebModules.findByProperties(["instantBatchUpload"]);
			this.CurrentUserPerms = BDFDBED.WebModules.findByProperties(["getChannelPermissions", "can"]);
			this.Permissions = BDFDBED.WebModules.findByProperties(["Permissions", "ActivityTypes"]).Permissions;
			this.GuildStore = BDFDBED.WebModules.findByProperties(["getGuilds"]);
			this.MemberPerms = BDFDBED.WebModules.findByProperties(["getNicknames", "getNick"]);
			this.MessageActions = BDFDBED.WebModules.findByProperties(['fetchMessages']);

			var observer = null;

			observer = new MutationObserver((changes, _) => {
				changes.forEach(
					(change, i) => {
						if (change.removedNodes) {
							change.removedNodes.forEach((node) => {
								if (node && node.tagName && node.getAttribute("layer-id") == "user-settings") {
									document.querySelectorAll("textarea" + BDFDBED.dotCN.textarea).forEach(textarea => {this.bindEventToTextArea(textarea);});
								}
							});
						}
					}
				);
			});
			BDFDBED.addObserver(this, BDFDBED.dotCN.layers, {name:"settingsWindowObserver",instance:observer}, {childList:true});

			observer = new MutationObserver((changes, _) => {
				changes.forEach(
					(change, i) => {
						if (change.addedNodes) {
							change.addedNodes.forEach((node) => {
								if (node && node.tagName && node.querySelector(BDFDBED.dotCN.textareainner + ":not(" + BDFDBED.dotCN.textareainnerdisabled + ")")) {
									this.bindEventToTextArea(node.querySelector("textarea"));
								}
							});
						}
					}
				);
			});
			BDFDBED.addObserver(this, BDFDBED.dotCN.appmount, {name:"textareaObserver",instance:observer}, {childList: true, subtree:true});

			observer = new MutationObserver((changes, _) => {
            changes.forEach(
	                (change, i) => {

	                    if (change.addedNodes) {
	                        change.addedNodes.forEach((node) => {
	                            if (node && node.nodeType == 1 && node.classList.length > 0 && node.className.includes(BDFDBED.disCN.contextmenu)) {
	                                this.onContextMenu(node);
	                            }
	                        });
	                    }
	                }
            	);
        	});
        	BDFDBED.addObserver(this, BDFDBED.dotCN.appmount, {name:"userContextObserver",instance:observer}, {childList: true});


			this.prefix = BDFDBED.BratishkinPrefix;
			this.aliases = BDFDBED.BratishkinCmds;
			
			document.querySelectorAll("textarea" + BDFDBED.dotCN.textarea).forEach(textarea => {this.bindEventToTextArea(textarea);});
			
			$(document).off("click." + this.getName()).on("click." + this.getName(), (e) => {
				if (e.target.tagName != "TEXTAREA") $(".autocompleteBratishkinAliases, .autocompleteBratishkinAliasesRow").remove();
			});
		}
		else {
			console.error(this.getName() + ": Fatal Error: Could not load BD functions!");
		}
	}

	stop () {
		if (typeof BDFDBED === "object") {
			$(".autocompleteBratishkinAliases, .autocompleteBratishkinAliasesRow").remove();
			
			BDFDBED.unloadMessage(this);
		}
	}


	// begin of own functions


	bindEventToTextArea (textarea) {
		if (!textarea) return;
		var channelObj = BDFDBED.getSelectedChannel();
		var channel = channelObj ? channelObj.data : null;
		if (!channel) return;
		if (channel.guild_id !== this.serverId) return;
		var settings = BDFDBED.getAllData(this, "settings"); 
		$(textarea)
			.off("keydown." + this.getName())
			.on("keydown." + this.getName(), e => {
				let autocompletemenu = textarea.parentElement.querySelector(BDFDBED.dotCN.autocomplete);
				if ((e.which == 9 || e.which == 13) && autocompletemenu) {
					if (autocompletemenu.querySelector(BDFDBED.dotCN.autocompleteselected).parentElement.classList.contains("autocompleteBratishkinAliasesRow")) {
						e.preventDefault();
						e.stopPropagation();
						this.swapWordWithAlias(textarea); 
					}
				}
				else if ((e.which == 38 || e.which == 40) && autocompletemenu) {
					let autocompleteitems = autocompletemenu.querySelectorAll(BDFDBED.dotCN.autocompleteselectable + ":not(.autocompleteBratishkinAliasesSelector)");
					let selected = autocompletemenu.querySelector(BDFDBED.dotCN.autocompleteselected);
					if (selected.classList.contains("autocompleteBratishkinAliasesSelector") || autocompleteitems[e.which == 38 ? 0 : (autocompleteitems.length-1)] == selected) {
						e.preventDefault();
						e.stopPropagation();
						let next = this.getNextSelection(autocompletemenu, null, e.which == 38 ? false : true);
						selected.classList.remove(BDFDBED.disCN.autocompleteselected);
						next.classList.add(BDFDBED.disCN.autocompleteselected);
						if (!next.classList.contains("autocompleteBratishkinAliasesSelector")) {
							// if next element is a default discord autocomplete item, trigger the keypress again so the item is internally selected
							var press = new KeyboardEvent("keypress", e);
							Object.defineProperty(press, "keyCode", {value: e.which});
							Object.defineProperty(press, "which", {value: e.which});
							textarea.dispatchEvent(press);
						}
					}
				}
				else if (!e.ctrlKey && textarea.selectionStart == textarea.selectionEnd && textarea.selectionEnd == textarea.value.length) {
					setImmediate(() => {this.addAutoCompleteMenu(textarea, channel);});
				}
				
				if (!e.ctrlKey && e.which != 38 && e.which != 40) {
					if (!(e.which == 39 && textarea.selectionStart == textarea.selectionEnd && textarea.selectionEnd == textarea.value.length)) {
						$(".autocompleteBratishkinAliases, .autocompleteBratishkinAliasesRow").remove();
					}
				}
			})
			.off("click." + this.getName())
			.on("click." + this.getName(), e => {
				if (textarea.selectionStart == textarea.selectionEnd && textarea.selectionEnd == textarea.value.length) {
					setImmediate(() => {this.addAutoCompleteMenu(textarea, channel);});
				}
			});
	}
	
	addAutoCompleteMenu (textarea, channel) {
		if (textarea.parentElement.querySelector(".autocompleteBratishkinAliasesRow")) return;
		let cmdword = textarea.value;
		if (cmdword) {
			let matchedaliases = {};
			for (let word in this.aliases) {
				let aliasdata = this.aliases[word];
				if ((this.prefix + word.toLowerCase()).indexOf(cmdword.toLowerCase()) == 0 && (!aliasdata.channel_id || aliasdata.channel_id == channel.id)) matchedaliases[word] = aliasdata;
			}
			if (!BDFDBED.isObjectEmpty(matchedaliases)) {
				let autocompletemenu = textarea.parentElement.querySelector(BDFDBED.dotCNS.autocomplete + BDFDBED.dotCN.autocompleteinner), amount = 15;
				if (!autocompletemenu) {
					autocompletemenu = $(`<div class="${BDFDBED.disCNS.autocomplete + BDFDBED.disCN.autocomplete2} autocompleteBratishkinAliases"><div class="${BDFDBED.disCN.autocompleteinner}"></div></div>`)[0];
					textarea.parentElement.appendChild(autocompletemenu);
					autocompletemenu = autocompletemenu.firstElementChild;
				}
				else {
					amount -= autocompletemenu.querySelectorAll(BDFDBED.dotCN.autocompleteselectable).length;
				}
				
				$(autocompletemenu)
					.append(`<div class="${BDFDBED.disCNS.autocompleterowvertical + BDFDBED.disCN.autocompleterow} autocompleteBratishkinAliasesRow"><div class="${BDFDBED.disCN.autocompleteselector} autocompleteBratishkinAliasesSelector"><div class="${BDFDBED.disCNS.autocompletecontenttitle + BDFDBED.disCNS.small + BDFDBED.disCNS.size12 + BDFDBED.disCNS.height16 + BDFDBED.disCN.weightsemibold}">Комманды сервера Баштеркина: <strong class="cmdword">${BDFDBED.encodeToHTML(cmdword)}</strong></div></div></div>`)
					.off("mouseenter." + this.getName()).on("mouseenter." + this.getName(), BDFDBED.dotCN.autocompleteselectable, (e) => {
						autocompletemenu.querySelectorAll(BDFDBED.dotCN.autocompleteselected).forEach(selected => {selected.classList.remove(BDFDBED.disCN.autocompleteselected);});
						e.currentTarget.classList.add(BDFDBED.disCN.autocompleteselected);
					});
					
				for (let word in matchedaliases) {
					if (amount-- < 1) break;
					$(`<div class="${BDFDBED.disCNS.autocompleterowvertical + BDFDBED.disCN.autocompleterow} autocompleteBratishkinAliasesRow"><div class="${BDFDBED.disCNS.autocompleteselector + BDFDBED.disCN.autocompleteselectable} autocompleteBratishkinAliasesSelector"><div class="${BDFDBED.disCNS.flex + BDFDBED.disCNS.flex2 + BDFDBED.disCNS.horizontal + BDFDBED.disCNS.horizontal2 + BDFDBED.disCNS.directionrow + BDFDBED.disCNS.justifystart + BDFDBED.disCNS.aligncenter + BDFDBED.disCNS.nowrap + BDFDBED.disCN.autocompletecontent}" style="flex: 1 1 auto;"><div class="${BDFDBED.disCN.flexchild}" style="flex: 1 1 auto;">${this.prefix}<span class="aliasword">${BDFDBED.encodeToHTML(word)}</span> <span style="color:#72767d;">${BDFDBED.encodeToHTML(this.argsToString(matchedaliases[word].args))}</span></div><div class="${BDFDBED.disCNS.autocompletedescription + BDFDBED.disCN.flexchild}">${BDFDBED.encodeToHTML(matchedaliases[word].desciption)}</div></div></div></div>`)
						.appendTo(autocompletemenu)
						.off("click." + this.getName()).on("click." + this.getName(), BDFDBED.dotCN.autocompleteselectable, (e) => {
							this.swapWordWithAlias(textarea);
						});
				}
				if (!autocompletemenu.querySelector(BDFDBED.dotCN.autocompleteselected)) {
					autocompletemenu.querySelector(".autocompleteBratishkinAliasesRow " + BDFDBED.dotCN.autocompleteselectable).classList.add(BDFDBED.disCN.autocompleteselected);
				}
			}
		}
	}
	
	getNextSelection (menu, selected, forward) {
		selected = selected ? selected : menu.querySelector(BDFDBED.dotCN.autocompleteselected).parentElement;
		let next, sibling = forward ? selected.nextElementSibling : selected.previousElementSibling;
		if (sibling) {
			next = sibling.querySelector(BDFDBED.dotCN.autocompleteselectable);
		}
		else {
			let items = menu.querySelectorAll(BDFDBED.dotCN.autocompleteselectable);
			next = forward ? items[0] : items[items.length-1]; 
		}
		return next ? next : this.getNextSelection(menu, sibling, forward);
	}
	
	swapWordWithAlias (textarea) {
		let aliasword = textarea.parentElement.querySelector(".autocompleteBratishkinAliasesRow " + BDFDBED.dotCN.autocompleteselected + " .aliasword").innerText;
		let cmdword = textarea.parentElement.querySelector(".autocompleteBratishkinAliasesRow .cmdword").innerText;
		if (aliasword && cmdword) {
			$(".autocompleteBratishkinAliases, .autocompleteBratishkinAliasesRow").remove();
			textarea.focus(); 
			textarea.selectionStart = textarea.value.length - cmdword.length + this.prefix.length;
			textarea.selectionEnd = textarea.value.length;
			document.execCommand("insertText", false, aliasword);
			textarea.selectionStart = textarea.value.length;
			textarea.selectionEnd = textarea.value.length;
		}
	}

	argsToString(cmdargs) {
		console.log(cmdargs)
		if(!cmdargs) return '';
		let result = ""
		for(let arg in cmdargs) {
			result += "<" + cmdargs[arg] + "> "
		}
		return result;
	}

	onContextMenu (context) {
        let serverObj = BDFDBED.getSelectedServer();
        serverObj=serverObj?serverObj: BDFDBED.getSelectedChannel();
        if (!context || !context.tagName || !context.parentElement || context.querySelector(".bratishkinCmds-item") || (serverObj.id!==this.serverId && serverObj.id!==this.botId)) return;
        let info = BDFDBED.getKeyInformation({"node":context, "key":"user"});
        if (info && BDFDBED.getKeyInformation({"node":context, "key":"displayName", "value":"UserNoteItem"})) {
            
            let userContextMenuMarkup= `<div class=${BDFDBED.disCN.contextmenuitemgroup}>`;
                    userContextMenuMarkup += `<div id="gc" class="${BDFDBED.disCNS.contextmenuitem} bratishkinCmds-item">`;

                    userContextMenuMarkup += `<span>${"Перевести кояны"}</span>`;

                    userContextMenuMarkup += `<div class="${BDFDBED.disCN.contextmenuhint}"></div>`;
                    userContextMenuMarkup += '</div>';
                userContextMenuMarkup+='</div>';
            userContextMenuMarkup+='</div>';
            $(context).append(userContextMenuMarkup)
                .on("click", "#gc", () => {
                    $(context).hide();
                    this.showTribunalSettings(info);
                })
            BDFDBED.updateContextPosition(context);;
        }
    }


    showTribunalSettings(info){
        const serverObj = this.GuildStore.getGuild(this.serverId);
        const member = serverObj ? this.MemberPerms.getMember(serverObj.id, info.id) : null;
        let description;
        let title, reason_title, warning, button_name;
        title = "Перевод coins";
        reason_title="Сумма перевода ";
        warning="Укажите сумму перевода";
        button_name="Перевести";
        
        let userTribunalSettings = $(this.userTribunalSettingsMarkup
            .replace("REPLACE_modal_title",title)
            .replace("REPLACE_modal_reason_title",reason_title+(member.nick ? member.nick : info.username)+'?')
            .replace("REPLACE_modal_warning",warning)
            .replace("REPLACE_modal_button_name",button_name));
        userTribunalSettings.find(".guildName-1u0hy7").text(member.nick ? member.nick : info.username);
        BDFDBED.appendModal(userTribunalSettings);
        userTribunalSettings
            .on("input change keyup paste", "#input-reason", (event) =>{
                if(userTribunalSettings.find("#input-reason").val()){
                    if(userTribunalSettings.find("#input-reason").val().trim().length > 0){
                        userTribunalSettings.find("button.btn-save").prop("disabled",false);
                        userTribunalSettings.find("#warning").css("visibility","hidden");
                    }else {
                        userTribunalSettings.find("button.btn-save").prop("disabled",true);
                        userTribunalSettings.find("#warning").css("visibility","visible");
                    }
                }else {
                    userTribunalSettings.find("button.btn-save").prop("disabled",true);
                    userTribunalSettings.find("#warning").css("visibility","visible");
                }
                if (event.keyCode === 13) {
                    userTribunalSettings.find("button.btn-save").click();
                }
            })
            .on("click", "button.btn-save", (event) => {
                event.preventDefault();
                description = null;
                if (userTribunalSettings.find("#input-reason").val()) {
                    if (userTribunalSettings.find("#input-reason").val().trim().length > 0) {
                        description = userTribunalSettings.find("#input-reason").val().trim();
                    }else{return;}
                }else{return;}
                let self=this;
                this.sendMessageInGeneral(this.prefix + 'gc <@!' + member.userId + '> ' + description);
            });
        userTribunalSettings.find("#input-reason").focus();
    }

    sendMessageInGeneral(msg){
        this.MessageActions.sendMessage(this.channelGeneralId,{content: msg});
    }

}
